(()=>{"use strict";function e(e){e.classList.add("popup_is-opened","popup_is-animated"),setTimeout((function(){e.classList.remove("popup_is-animated")}),0),document.addEventListener("keydown",n)}function t(){var e=document.querySelector(".popup_is-opened");setTimeout((function(){e.classList.remove("popup_is-opened","popup_is-animated")}),600),e.classList.add("popup_is-animated"),document.removeEventListener("keydown",n)}function n(e){"Escape"===e.key&&t()}function r(e){(e.target.classList.contains("popup")||e.target.classList.contains("popup__close"))&&t()}function o(e){document.querySelector(".popup_is-opened").querySelector(".popup__button").textContent=e?"Сохранение...":"Сохранить"}function c(e,t,n){var r=e.querySelector(".error_type_".concat(t.name));t.classList.remove(n.inputErrorClass),r.classList.remove(n.errorClass),r.textContent=""}function a(e,t,n){!function(e){return e.some((function(e){return!e.validity.valid}))}(e)?(t.disabled=!1,t.classList.remove(n.inactiveButtonClass)):(t.disabled=!0,t.classList.add(n.inactiveButtonClass))}function u(e,t){Array.from(e.querySelectorAll(t.inputSelector)).forEach((function(n){c(e,n,t);var r=e.querySelector(t.submitButtonSelector);r.disabled=!0,r.classList.add(t.inactiveButtonClass)}))}var i={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},s=document.querySelector("#card-template").content,l=[],d=[],p=null;function _(e){e.classList.toggle("card__like-button_is-active"),e.classList.toggle("card__like-button")}var f=document.querySelector(".popup_type_image"),m=f.querySelector(".popup__image"),h=f.querySelector(".popup__caption");function v(t){var n=t.target.closest(".card").querySelector(".card__title");m.src=t.target.src,m.alt=t.target.alt,h.textContent=n.textContent,e(f)}f.addEventListener("click",r);var y={baseUrl:"https://nomoreparties.co/v1/wff-cohort-18",headers:{authorization:"4457ae31-f058-4fe9-a14e-7149a426cdd0","Content-Type":"application/json"}},S={};function q(){return fetch("".concat(y.baseUrl,"/users/me"),{method:"GET",headers:y.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).then((function(e){return e._id}))}function b(e){var t=q();return Promise.all([t]).then((function(){var t=!1;return e.length>0&&e.forEach((function(e){if(e._id==S._id)return t=!0})),t}))}function k(){return fetch("".concat(y.baseUrl,"/users/me"),{method:"GET",headers:y.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).then((function(e){S=e;var t=document.querySelector(".profile__image"),n=document.querySelector(".profile__title"),r=document.querySelector(".profile__description");t.src=e.avatar,n.textContent=e.name,r.textContent=e.about}))}function E(){return fetch("".concat(y.baseUrl,"/cards"),{method:"GET",headers:y.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).then((function(t){var n,r=document.querySelector(".places__list");t.forEach((function(t){var o,c;o=t.owner._id,c=q(),n=Promise.all([c]).then((function(e){return e==o})),Promise.all([n,b(t.likes)]).then((function(n){var o=function(t,n,r,o,c,a,u,i){var _=s.querySelector(".card").cloneNode(!0),f=_.querySelector(".card__delete-button"),m=_.querySelector(".card__image"),h=_.querySelector(".card__title"),v=_.querySelector(".card__like-button"),q=_.querySelector(".card__like-count"),b=document.querySelector(".popup_type_delete");return m.src=n,m.alt="Картинка "+t,h.textContent=t,q.textContent=r,a&&(v.classList.add("card__like-button_is-active"),v.classList.remove("card__like-button")),d.push({json:i,card:_}),u?(l.push({json:i,card:_}),f.addEventListener("click",(function(t){p=t.target.closest(".card"),e(b)}))):f.remove(),v.addEventListener("click",(function(e){p=e.target.closest(".card"),d.forEach((function(t){var n,r,c;p==t.card&&(v.classList.contains("card__like-button_is-active")?(o(e.target),t.json.likes.forEach((function(e,n){e._id==S._id&&t.json.likes.splice(n,1)})),n=t.json._id,r=t.json.likes,c=p.querySelector(".card__like-count"),fetch("".concat(y.baseUrl,"/cards/likes/").concat(n),{method:"DELETE",headers:y.headers,body:JSON.stringify({likes:r})}).then((function(){L(n,c)})).catch((function(e){return console.log(e)}))):(o(e.target),t.json.likes.push(S),function(e,t,n){fetch("".concat(y.baseUrl,"/cards/likes/").concat(e),{method:"PUT",headers:y.headers,body:JSON.stringify({likes:t})}).then((function(){L(e,n)})).catch((function(e){return console.log(e)}))}(t.json._id,t.json.likes,p.querySelector(".card__like-count"))))}))})),m.addEventListener("click",c),_}(t.name,t.link,t.likes.length,_,v,n[1],n[0],t);r.append(o)}))}))}))}function L(e,t){return fetch("".concat(y.baseUrl,"/cards"),{method:"GET",headers:y.headers}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).then((function(n){n.forEach((function(n){n._id==e&&(t.textContent=n.likes.length)}))}))}var g=document.querySelector(".popup_type_edit"),C=document.querySelector(".profile__edit-button"),j=g.querySelector(".popup__form"),T=j.querySelector(".popup__input_type_name"),x=j.querySelector(".popup__input_type_description");C.addEventListener("click",(function(){T.value=document.querySelector(".profile__title").textContent,x.value=document.querySelector(".profile__description").textContent,u(j,i),e(g)})),g.addEventListener("click",r),j.addEventListener("submit",(function(e){var n,r;o(!0),e.preventDefault(),(n=T.value,r=x.value,fetch("".concat(y.baseUrl,"/users/me"),{method:"PATCH",headers:y.headers,body:JSON.stringify({name:n,about:r})}).then((function(e){return e.json()})).then((function(){k()})).catch((function(e){return console.log(e)}))).then((function(){o(!1),t()}))}));var U=document.querySelector(".popup_type_new-card"),P=document.querySelector(".profile__add-button"),A=(document.querySelector(".places__list"),U.querySelector(".popup__form")),B=A.querySelector(".popup__input_type_card-name"),w=A.querySelector(".popup__input_type_url");P.addEventListener("click",(function(){e(U)})),U.addEventListener("click",r),A.addEventListener("submit",(function(e){var n,r;o(!0),e.preventDefault(),(n=B.value,r=w.value,fetch("".concat(y.baseUrl,"/cards"),{method:"POST",headers:y.headers,body:JSON.stringify({name:n,link:r})}).then((function(){document.querySelector(".places__list").replaceChildren(),E()})).catch((function(e){return console.log(e)}))).then((function(){o(!1),t(),A.reset(),u(A,i)}))}));var D=document.querySelector(".popup_type_delete"),N=D.querySelector(".popup__button");D.addEventListener("click",r),N.addEventListener("click",(function(e){e.preventDefault(),l.forEach((function(e){var t;p==e.card&&(t=e.json._id,fetch("".concat(y.baseUrl,"/cards/").concat(t),{method:"DELETE",headers:y.headers}).catch((function(e){return console.log(e)})),p.remove())})),t()}));var O=document.querySelector(".popup_type_new-avatar"),J=document.querySelector(".profile__edit-button_avatar"),G=O.querySelector(".popup__form"),z=G.querySelector(".popup__input_type_url");J.addEventListener("click",(function(){u(G,i),e(O)})),O.addEventListener("click",r),G.addEventListener("submit",(function(e){var n;o(!0),e.preventDefault(),(n=z.value,fetch("".concat(y.baseUrl,"/users/me/avatar"),{method:"PATCH",headers:y.headers,body:JSON.stringify({avatar:n})}).then((function(e){return e.json()})).then((function(){k()})).catch((function(e){return console.log(e)}))).then((function(){o(!1),t()}))})),k(),E(),function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((function(t){!function(e,t){var n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);a(n,r,t),n.forEach((function(o){o.addEventListener("input",(function(){!function(e,t,n){"name"!=t.name&&"place-name"!=t.name||!/[^a-zа-яё\s-]/i.test(t.value)?t.setCustomValidity(""):t.setCustomValidity(t.dataset.errorMessage),t.validity.valid?c(e,t,n):function(e,t,n,r){var o=e.querySelector(".error_type_".concat(t.name));t.classList.add(r.inputErrorClass),o.textContent=n,o.classList.add(r.errorClass)}(e,t,t.validationMessage,n)}(e,o,t),a(n,r,t)}))}))}(t,e)}))}(i)})();